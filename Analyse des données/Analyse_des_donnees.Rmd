---
title: "Enquête Data Publica, édition 2023"
subtitle: "Analyse des données de l’enquête"
date: "Dernière modification le `r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      toc_depth: 2
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	error = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis",
	fig.height=9, 
	fig.width=20
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/ReT2njwQenxiFtX/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:-0.5; padding-top:-2px; width:350px;') #padding=taille des espaces autour
```


```{r données}
# Import de données
library(tidyverse)
data <- read_csv("../Data/results-survey396597.csv") |> select(1:220)
CT_enrichies <- read_csv("../Data/interim_data.csv")

# Jointure questionnaire + type de structure récupéré en pre-processing
data <- data |> 
    left_join(CT_enrichies |> select(-2), by = "ID de la réponse") |> 
    mutate(Catégorie = case_when(Catégorie == "Commune" ~ "Une commune",
                                 Catégorie == "Metropole" ~ "Une métropole",
                                 Catégorie == "Departement" ~ "Un département",
                                 Catégorie == "Region" ~ "Une région",
                                 Catégorie == "EPCI" ~ "Un EPCI (hors métropole)"),
           Catégorie2 = case_when(Catégorie == "Une commune" & `Population totale` < 3500 ~ "Communes de moins de 3 500 hab.",
                               Catégorie == "Une commune" & `Population totale` >= 3500 & `Population totale` < 10000 ~ "Communes de 3 500 à 10 000 hab.",
                               Catégorie == "Une commune" & `Population totale` >= 10000 & `Population totale` < 100000 ~ "Communes de 10 000 à 100 000 hab.",
                               Catégorie == "Une commune" & `Population totale` >= 100000 ~ "Communes de plus de 100 000 hab.",
                               is.na(Catégorie) ~ "Autre",
                               .default = Catégorie),
           Catégorie = case_when(is.na(Catégorie) ~ "Autre", .default = Catégorie))

# Données complètes
data_clean <- data |> 
    filter(!is.na(`Votre structure a-t-elle engagé une réflexion sur les enjeux du numérique responsable ?`))
data_clean_unique <- data_clean |> 
    mutate(nb_na = rowSums(is.na(data_clean))) |> 
    mutate(n = n(), .by = nom) |> 
    group_by(nom) |> slice(which.min(nb_na)) |> ungroup()
data_clean_unique |> 
    rename(structure = Catégorie, structure_pop = Catégorie2) |> 
    select(-c(2:10, SIREN, COG, nb_na, n)) |> 
    rio::export("../Data/process_data.csv")

# Liste des régions
library(tools)
reg <- data_clean_unique |> filter(Catégorie == "Une région") |> 
    mutate(nom = toTitleCase(tolower(nom))) |> distinct(nom) |> t()
```


```{r prepa graph}
# Import des données des stats rassemblés
all_stat <- read_csv("../Data/All_statistics.csv")

# Thème ggplot customisé
font <- "Helvetica"
custom_theme <- function (){
    font <- "Helvetica"
    ggplot2::theme(plot.title = ggplot2::element_text(family = font,size = 25, face = "bold", color = "#222222"), 
        plot.subtitle = ggplot2::element_text(family = font,size = 15, face = "italic", margin = ggplot2::margin(0, 0, 9, 0)), 
        plot.caption = ggplot2::element_text(family = font,size = 15, margin = ggplot2::margin(9, 0, 9, 0)), 
        legend.title = ggplot2::element_text(family = font, size = 15, color = "#222222"), 
        legend.position = "top", 
        legend.text.align = 0, 
        legend.background = ggplot2::element_blank(),
        legend.key = ggplot2::element_blank(),
        legend.text = ggplot2::element_text(family = font, size = 13,color = "#222222"), 
        axis.text = ggplot2::element_text(family = font, size = 20,color = "#222222"), 
        axis.text.x = ggplot2::element_text(margin = ggplot2::margin(5,b = 10)), 
        axis.title = ggplot2::element_text(family = font, size = 22,color = "#222222"),
        axis.ticks = ggplot2::element_blank(),
        axis.line = ggplot2::element_blank(), 
        panel.grid.minor = ggplot2::element_blank(),
        panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.x = ggplot2::element_blank(), 
        panel.background = ggplot2::element_blank(),
        strip.background = ggplot2::element_rect(fill = "white"),
        strip.text = ggplot2::element_text(size = 22, hjust = 0, face = "bold"))
}
# couleurs data publica
    ## Vieille pres
    # bleu foncé : 273768
    # cyan fluo : 3de5fc
    # jaune fluo : ffcd1c

    ## Site Observatoire
    # bleu foncé : 323465
    # cyan plus foncé : 33bbc9
    # jaune / orange : e1b44d

# Librairies et fonction d'export des graphs
library(cowplot)
library(gridExtra)
library(glue)
saving_plot <- function(graph, name) {
  ggsave(file = glue("../Graphiques/PNG/{name}.png"), plot = graph)
  ggsave(file = glue("../Graphiques/SVG/{name}.svg"), plot = graph)
}
```

## Droit des données publiques

### Commençons par la protection de la vie privée. Considérez-vous que votre structure est en conformité avec le RGPD ?

+ **Statistiques**

```{r qs1}
# Stats individuelles
stat_qs_simple <- function(n_col, nom_col){
   cat2 <- data_clean_unique |> 
        select(n_col, Catégorie2) |> 
        summarise(n = n(), .by = c(Catégorie2, 1)) |> na.omit() |>  
        pivot_wider(names_from = 2, values_from = 3) |>
        janitor::adorn_totals("row") |>
        pivot_longer(cols = -Catégorie2, names_to = "cat", values_to = "n") |> 
        mutate(Catégorie2 = case_when(Catégorie2 == "Total" ~ paste0("Total (", sum(n[Catégorie2 == "Total"]), " réponses)"), .default = Catégorie2)) |> 
        mutate_all(replace_na, replace = 0) |>
        mutate(percent = paste0(round(n / sum(n) *100, 0), "%"), .by = Catégorie2) |> 
        select(-n) |> pivot_wider(names_from = 2, values_from = 3)
    cat1 <- data_clean_unique |> 
        select(n_col, Catégorie) |> 
        filter(Catégorie == "Une commune") |> 
        summarise(n = n(), .by = c(Catégorie, 1)) |> na.omit() |>  
        mutate_all(replace_na, replace = 0) |>
        mutate(percent = paste0(round(n / sum(n) *100, 0), "%"), .by = Catégorie) |> 
        select(-n) |> pivot_wider(names_from = 2, values_from = 3)
    nb_col <- ncol(cat2)
    
    stat_indiv <- list(cat1, cat2 |> rename(Catégorie = Catégorie2)) |> 
        bind_rows() |> ungroup() |> 
        mutate_all(replace_na, replace = "0%") |>  
        mutate(index = case_match(Catégorie, 
                                  "Une commune" ~ 2,
                                  "Communes de moins de 3 500 hab." ~ 3,
                                  "Communes de 3 500 à 10 000 hab." ~ 4,
                                  "Communes de 10 000 à 100 000 hab." ~ 5,
                                  "Communes de plus de 100 000 hab." ~ 6,
                                  "Une métropole" ~ 7,
                                  "Un EPCI (hors métropole)" ~ 8,
                                  "Un département" ~ 9,
                                  "Une région" ~ 10,
                                  "Autre" ~ 11, 
                                  .default = 1)) |> 
        arrange(index) |> select(-index) |> 
        rename({{ nom_col }} := 1) 
    knitr::kable(stat_indiv, format = "html") |> 
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
}
stat_qs_simple(13, "Commençons par la protection de la vie privée. Considérez-vous que votre structure est en conformité avec le RGPD ?")
```

+ **Visualisation**

```{r fig.height=9, fig.width=20}
dataviz <- function(nom_col){
    # Fonction graph ensemble
    dat <- all_stat |> 
        filter(Question == nom_col & Structure == "Total")
    p0 <- dat |> 
        ggplot(aes(y=Occurrences, x=Réponses, fill = Réponses)) + 
            geom_bar(position="dodge", stat="identity", width=.6, size = 1, alpha = .9) +
            labs(x = "", y = "Nombre de réponses", 
                 title = paste("Toutes les collectivités,", dat$`Nombre de réponses`, "réponses")) +
            geom_label(aes(x = Réponses, y = Occurrences+1, label = paste0(Pourcentage, "%")), 
                       size = 8, fill = "white", label.size = NA, hjust = 0) +
            scale_fill_manual(values = c("grey", "#bf0001", "#e1b44d", "#33bbc9", "#323465")) +
            scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 30)) +
            ylim(0, max(dat$Occurrences)+14) +
            coord_flip() +
            theme_classic() +
            custom_theme() +
            theme(legend.position = "none",
                  plot.title = element_text(hjust = 1),
                  panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
                  panel.grid.major.y = ggplot2::element_blank())
    # Fonction type de collectivité
    dat <- all_stat |> 
        filter(Question == nom_col & (Structure == "Une commune" | Structure == "Un EPCI (hors métropole)" | Structure == "Une métropole" | Structure == "Un département" | Structure == "Une région" | Structure == "Autre")) |> 
        mutate(Pourcentage = as.numeric(Pourcentage)/100,
               Structure = factor(Structure, levels = c("Autre","Une région","Un département","Une métropole","Un EPCI (hors métropole)","Une commune")))
    p1 <- dat |> 
        ggplot(aes(fill=Réponses, y=Pourcentage, x=Structure)) + 
        geom_bar(position="fill", color = "white", stat="identity", alpha = .9) +
        labs(x = "", y = "Pourcentage de réponses", title = "Par type de collectivité") +
        scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
        scale_fill_manual(values = c("grey", "#bf0001", "#e1b44d", "#33bbc9", "#323465")) +
        coord_flip() +
        theme_classic() +
        custom_theme() +
        guides(fill = guide_legend(nrow = 3, title = "", reverse = T)) +
            theme(legend.position = "none",
                  panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
                  panel.grid.major.y = ggplot2::element_blank())
    # Fonction taille de commune
    dat <- all_stat |> 
        filter(Question == nom_col & grepl("Communes de", Structure) == TRUE) |> 
        mutate(Pourcentage = as.numeric(Pourcentage)/100,
               Structure = factor(Structure, levels = c("Communes de plus de 100 000 hab.","Communes de 10 000 à 100 000 hab.","Communes de 3 500 à 10 000 hab.","Communes de moins de 3 500 hab.")),
               Structure = str_replace_all(Structure, c("Communes de " = "", "p" = "P", "m" = "M")))
    p2 <- dat |> 
        ggplot(aes(fill=Réponses, y=Pourcentage, x=Structure)) + 
        geom_bar(position="fill", color = "white", stat="identity", alpha = .9) +
        labs(x = "", y = "Pourcentage de réponses", title = "Par taille de commune") +
        scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
        scale_fill_manual(values = c("grey", "#bf0001", "#e1b44d", "#33bbc9", "#323465")) +
        coord_flip() +
        theme_classic() +
        custom_theme() +
        guides(fill = guide_legend(nrow = 3, title = "", reverse = T)) +
        theme(legend.position = "none",
                  panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
              panel.grid.major.y = ggplot2::element_blank())
    p1.2 <- plot_grid(p1, p2, align = 'v', nrow = 2)
    graph <- grid.arrange(p0,p1.2, ncol = 2, nrow = 1)
    assign("graph", graph, envir = .GlobalEnv)
    grid::grid.draw(graph)
    saving_plot(graph, nom_col)
}
dataviz("Commençons par la protection de la vie privée. Considérez-vous que votre structure est en conformité avec le RGPD ?")
```


### Avez-vous nommé un(e) Délégué(e) à la Protection des Données (DPO) ?

+ **Statistiques**

```{r}
stat_qs_simple(14, "Avez-vous nommé un(e) Délégué(e) à la Protection des Données (DPO) ?")
```

+ **Visualisation**

```{r}
dataviz("Avez-vous nommé un(e) Délégué(e) à la Protection des Données (DPO) ?")
```


### Afin de respecter le RGPD, avez-vous modifié des processus de gestion des données au sein de l'organisation ?

+ **Statistiques**

```{r}
stat_qs_simple(15, "Afin de respecter le RGPD, avez-vous modifié des processus de gestion des données au sein de l'organisation ?")
```


+ **Visualisation**

```{r}
dataviz("Afin de respecter le RGPD, avez-vous modifié des processus de gestion des données au sein de l'organisation ?")
```

### De manière générale, avez-vous mis en place des clauses juridiques sur la gestion des données dans les contrats de délégation et dans les marchés publics ?

+ **Statistiques**

```{r}
stat_qs_simple(18, "De manière générale, avez-vous mis en place des clauses juridiques sur la gestion des données dans les contrats de délégation et dans les marchés publics ?")
```

+ **Visualisation**

```{r}
dataviz("Afin de respecter le RGPD, avez-vous modifié des processus de gestion des données au sein de l'organisation ?")
```

