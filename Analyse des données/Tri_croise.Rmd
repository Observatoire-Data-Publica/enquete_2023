---
title: "Tri croisé des réponses"
subtitle: "Enquête Data Publica, édition 2023"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

# Import des données


```{r données}
library(tidyverse)
data <- read_csv("../results-survey396597.csv")
communes <- read_delim("https://data.ofgl.fr/api/explore/v2.1/catalog/datasets/ofgl-base-communes-consolidee/exports/csv?lang=fr&facet=facet(name%3D%22reg_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22dep_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22epci_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22tranche_population%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22tranche_revenu_imposable_par_habitant%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22com_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22agregat%22%2C%20disjunctive%3Dtrue)&refine=exer%3A%222022%22&refine=agregat%3A%22Achats%20et%20charges%20externes%22&timezone=Europe%2FBerlin&use_labels=true&delimiter=%3B", ";") |> 
    select(`Code Siren Collectivité`, `Code Insee Collectivité`, `Nom 2022 Commune`, `Population totale`, `Catégorie`) |> 
    rename(COG = `Code Insee Collectivité`,
           nom = `Nom 2022 Commune`,
           SIREN = `Code Siren Collectivité`) |> 
    mutate(SIREN = as.character(SIREN),
           COG = as.character(COG)) |> 
    arrange(COG)
regions <- read_delim("https://data.ofgl.fr/api/explore/v2.1/catalog/datasets/ofgl-base-regions-consolidee/exports/csv?lang=fr&facet=facet(name%3D%22reg_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22agregat%22%2C%20disjunctive%3Dtrue)&refine=exer%3A%222022%22&refine=agregat%3A%22Achats%20et%20charges%20externes%22&timezone=Europe%2FBerlin&use_labels=true&delimiter=%3B", ";") |> 
    select(`Code Siren Collectivité`, `Code Insee 2022 Région`, `Nom 2022 Région`, `Population totale`, `Catégorie`) |> 
    rename(COG = `Code Insee 2022 Région`,
           nom = `Nom 2022 Région`,
           SIREN = `Code Siren Collectivité`) |> 
    mutate(SIREN = as.character(SIREN),
           COG = as.character(COG)) |> 
    arrange(COG)
departements <- read_delim("https://data.ofgl.fr/api/explore/v2.1/catalog/datasets/ofgl-base-departements-consolidee/exports/csv?lang=fr&facet=facet(name%3D%22reg_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22dep_tranche_population%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22dep_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22agregat%22%2C%20disjunctive%3Dtrue)&refine=exer%3A%222022%22&refine=agregat%3A%22D%C3%A9penses%20totales%22&timezone=Europe%2FBerlin&use_labels=true&delimiter=%3B", ";") |> 
    select(`Code Siren Collectivité`, `Code Insee 2022 Département`, `Nom 2022 Département`, `Population totale`, `Catégorie`) |> 
    rename(COG = `Code Insee 2022 Département`,
           nom = `Nom 2022 Département`,
           SIREN = `Code Siren Collectivité`) |> 
    mutate(SIREN = as.character(SIREN),
           COG = as.character(COG)) |> 
    arrange(COG)
epci <- read_delim("https://data.ofgl.fr/api/explore/v2.1/catalog/datasets/ofgl-base-ei/exports/csv?lang=fr&facet=facet(name%3D%22libelle_categ%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22dep_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22gfp_tranche_population%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22nat_juridique%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22mode_financement%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22gfp_tranche_revenu_imposable_par_habitant%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22epci_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22agregat%22%2C%20disjunctive%3Dtrue)&refine=exer%3A%222022%22&refine=agregat%3A%22Achats%20et%20charges%20externes%22&timezone=Europe%2FBerlin&use_labels=true&delimiter=%3B", ";") |> 
    select(`Code Siren 2022 EI`, `Nom 2022 EI`, `Population totale`, `Catégorie`) |> 
    rename(nom = `Nom 2022 EI`,
           SIREN = `Code Siren 2022 EI`) |> 
    mutate(SIREN = as.character(SIREN),
           COG = NA_character_) |> 
    arrange(COG)
coll_ter <- rbind(regions, departements, communes, epci)
```

Les données sont composées de `r norw(data)` réponses et `r ncol(data)` variables. Elles sont enrichies par le type de territoire et la population extraits des [données OFGL](https://data.ofgl.fr/explore/?exclude.theme=INTERNE&sort=title).

```{r enrich data}
test <- data |> 
    mutate(nom = toupper(str_replace_all(`Quel est le nom de votre structure ?`, "[^[:alnum:]]", " ")), #remove special char
           nom = str_replace_all(nom, "[0-9]", ""), # remove digits
           nom = trimws(nom, which = "both"), #remove white space end of string
           nom = stringi::stri_trans_general(str = nom, id = "Latin-ASCII"), #remove accents
           nom = str_replace_all(nom, c("DEPARTEMENT D " = "", "DEPARTEMENT DE " = "", 
                                        "DEPARTEMENT DE LA " = "", "DEPARTEMENT " = "", 
                                        "DEPARTEMENT DU " = "", "COMMUNE DE " = "", 
                                        "COMMUNE DE LA " = "", "MAIRIE DE " = "",
                                        "MAIRIE D " = "", "CONSEIL DEPARTEMENTAL DE L " = "",
                                        "CONSEIL DEPARTEMENTAL DE LA " = "",
                                        "CONSEIL DEPARTEMENTAL DES " = "",
                                        "CONSEIL DEPARTEMENTAL DE " = "",
                                        "CONSEIL DEPARTEMENTAL DU " = "",
                                        "CONSEIL REGIONAL " = "",
                                        "CONSEIL REGIONAL D " = "",
                                        "CONSEIL REGIONAL DES " = "",
                                        "COMMUNAUTE DE COMMUNES" = "CC",
                                        "COMMUNAUTE D AGGLOMERATION" = "CA"
                                        ))) |>  
    left_join(coll_ter |> mutate(nom = toupper(nom),
                                 nom = toupper(str_replace_all(nom, "[^[:alnum:]]", " ")), #remove special char
                                 nom = str_replace_all(nom, "[0-9]", ""), # remove digits
                                 nom = trimws(nom, which = "both"),
                                 nom = stringi::stri_trans_general(str = nom, id = "Latin-ASCII")), 
              by = "nom") |> 
    select(`Quel est le nom de votre structure ?`, 303:307)
```


## Les petites astuces

Quelques paramètres à changer si vous voulez un R Markdown légèrement différent : 

- `<br>` saute une ligne entre 2 éléments 
- `number_sections: true` dans l'en-tête de ce document numérote automatiquement les parties et sous-parties (retirer le `#` dans l'en-tête pour l'utiliser)
- `toc: false` supprime la table des matières (table of contents, *toc*) qui s'affiche par défaut au début du document avec une profondeur maximale de 4 actuellement
- `date: "1er janvier 2023"` affiche une date fixe car entrée comme un texte. Actuellement c'est la date du jour où le rapport est généré qui apparaît automatiquement dans l'en-tête du document
- **texte en gras**, *texte en italique*, ***texte en gras italique***

# Une deuxième section divisée en 3

<div class = "row">
  
<div class = "col-md-4">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi.
</div>
  
<div class = "col-md-4">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi.
</div>
  
<div class = "col-md-4">
```{r graph}
library(tidyverse)
ggplot( mtcars, aes(x=mpg)) + 
  geom_histogram(fill="skyblue", alpha=0.5) + 
  theme_minimal()
```
</div>
</div>

## Faire ressortir du texte dans une boxe


<br>

<style>
div.blue { background-color:#fff1eb; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

**Ma boxe**

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat. Duis semper. Duis arcu massa, scelerisque vitae, consequat in, pretium a, enim.

</div>

