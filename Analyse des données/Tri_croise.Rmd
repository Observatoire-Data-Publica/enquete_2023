---
title: "Tri croisé des réponses"
subtitle: "Enquête Data Publica, édition 2023"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

# Import des données


```{r données}
library(tidyverse)
data <- read_csv("../results-survey396597.csv") |> select(1:220)
CT_enrichies <- read_csv("../interim_data.csv")
data <- data |> 
    left_join(CT_enrichies |> select(-2), by = "ID de la réponse") |> 
    mutate(Catégorie2 = case_when(Catégorie == "Commune" & `Population totale` < 3500 ~ "Communes de moins de 3 500 hab.",
                               Catégorie == "Commune" & `Population totale` >= 3500 & `Population totale` < 10000 ~ "Communes de 3 500 à 10 000 hab.",
                               Catégorie == "Commune" & `Population totale` >= 10000 & `Population totale` < 100000 ~ "Communes de 10 000 à 100 000 hab.",
                               Catégorie == "Commune" & `Population totale` >= 100000 ~ "Communes de plus de 100 000 hab.",
                               is.na(Catégorie) ~ "Autre",
                               .default = Catégorie),
           Catégorie = case_when(is.na(Catégorie) ~ "Autre", .default = Catégorie))
data_clean <- data |> 
    filter(!is.na(`Votre structure a-t-elle engagé une réflexion sur les enjeux du numérique responsable ?`))
data_clean_unique <- data_clean |> 
    distinct(nom, Catégorie, Catégorie2)
```

Les données sont composées de `r nrow(data)` réponses (complètes comme incomplètes) et `r ncol(data)` variables. Elles sont enrichies par le type de territoire et la population extraits des [données OFGL](https://data.ofgl.fr/explore/?exclude.theme=INTERNE&sort=title) en plusieurs étapes :

- retrait des accents, chiffres et caractères spéciaux des noms de structure et mise en majuscule ;
- jointure avec les données OFGL par le nom de structure (lui aussi sans caractères spéciaux etc.) ;
- complétion manuelle du type de structure et de la population pour les structures non enrichies par les données OFGL ; 
- vérification des jointures multiples lorsque plusieurs CT ont un même nom, choix de la bonne collectivité via les informations renseignées dans le questionnaire.

Sont considérées comme complètes toutes les réponses ayant répondu à la question *Votre structure a-t-elle engagé une réflexion sur les enjeux du numérique responsable ?*, soit `r nrow(data_clean_unique)` observations en retirant les doublons. Les **types de structure** ayant répondu sont les suivants : 

- `r data_clean_unique |> filter(Catégorie == "Region") |> nrow()` régions ;
- `r data_clean_unique |> filter(Catégorie == "Departement") |> nrow()` départements ;
- `r data_clean_unique |> filter(Catégorie == "Commune") |> nrow()` communes ;
    - `r data_clean_unique |> filter(Catégorie2 == "Communes de moins de 3 500 hab.") |> nrow()` communes de moins de 3 500 habitants ;
    - `r data_clean_unique |> filter(Catégorie2 == "Communes de 3 500 à 10 000 hab.") |> nrow()` communes de 3 500 à 10 000 habitants ;
    - `r data_clean_unique |> filter(Catégorie2 == "Communes de 10 000 à 100 000 hab.") |> nrow()` communes de 10 000 à 100 000 habitants ;
    - `r data_clean_unique |> filter(Catégorie2 == "Communes de plus de 100 000 hab.") |> nrow()` communes de plus de 100 000 habitants ;
- `r data_clean_unique |> filter(Catégorie == "EPCI") |> nrow()` EPCI ;
- `r data_clean_unique |> filter(Catégorie == "Autre") |> nrow()` structures '*Autre*', c'est-à-dire n'entrant pas dans les catégories précédentes.


# Tri croisé

## Commençons par la protection de la vie privée. Considérez-vous que votre structure est en conformité avec le RGPD ?

```{r enrich data}
test <- data_clean |> 
    select(`Commençons par la protection de la vie privée. Considérez-vous que votre structure est en conformité avec le RGPD ?`, 
           Catégorie2) |> 
    summarise(n = n(), .by = c(Catégorie2, `Commençons par la protection de la vie privée. Considérez-vous que votre structure est en conformité avec le RGPD ?`)) |> na.omit() |>  
    pivot_wider(names_from = 2, values_from = 3) |>
    janitor::adorn_totals("row") |>
    pivot_longer(cols = -Catégorie2, names_to = "cat", values_to = "n") |> 
    mutate_all(replace_na, replace = 0) |>
    mutate(percent = round(n / sum(n) *100, 0), .by = Catégorie2) |> 
    select(-n) |> pivot_wider(names_from = 2, values_from = 3)

test <- data_clean |> 
    select(`Commençons par la protection de la vie privée. Considérez-vous que votre structure est en conformité avec le RGPD ?`, 
           Catégorie) |> 
    summarise(n = n(), .by = c(Catégorie, `Commençons par la protection de la vie privée. Considérez-vous que votre structure est en conformité avec le RGPD ?`)) |> na.omit() |>  
    pivot_wider(names_from = 2, values_from = 3) |>
    janitor::adorn_totals("row") |>
    pivot_longer(cols = -Catégorie, names_to = "cat", values_to = "n") |> 
    mutate_all(replace_na, replace = 0) |>
    mutate(percent = round(n / sum(n) *100, 0), .by = Catégorie) |> 
    select(-n) |> pivot_wider(names_from = 2, values_from = 3)


    mutate(Catégorie = factor(Catégorie, levels = c("")))
```


















